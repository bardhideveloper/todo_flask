{% extends "base.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<div class="two-columns">

    <div class="card add-card">
        <h2>New Task</h2>

        <form action="/add" method="POST">
            <input type="text" name="task" placeholder="Task name..." required>

            <label>Deadline:</label>
            <input type="date" name="deadline">

            <label>Priority:</label>
            <select name="priority">
                <option value="Low">Low</option>
                <option value="Medium" selected>Medium</option>
                <option value="High">High</option>
            </select>

            <button type="submit">Add Task</button>
        </form>

    </div>

    <div class="card tasks-card">
        <h2>{{ current_user.username }} Tasks</h2>

        <ul id="tasks-list">
            {% for t in tasks %}
            <li data-id="{{ t.id }}" class="{% if t.completed %}done{% endif %}">

                <div class="task-info">
                    <strong>{{ t.task }}</strong><br>

                    <div class="task-meta-row">
                        {% if t.deadline %}
                        <div class="deadline-badge">ðŸ“… {{ t.deadline }}</div>
                        {% endif %}
                        <div class="priority-badge {{ t.priority|lower }}">{{ t.priority }}</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <a href="/complete/{{ t.id }}" class="btn-icon success">âœ”</a>

                    <a href="/edit/{{ t.id }}" class="btn-icon warning edit-btn">âœŽ</a>

                    <a href="/delete/{{ t.id }}" class="btn-icon danger">âœ–</a>
                </div>

            </li>
            {% endfor %}
        </ul>
    </div>

</div>

<div id="editModal" class="modal" style="display:none;">
    <div class="modal-content card">
        <span id="closeModal" class="close-btn">Ã—</span>
        <div id="modal-body">
            <!-- edit_form.html loads here -->
        </div>
    </div>
</div>

<script>
    /* SortableJS for drag-reorder */
    const list = document.getElementById("tasks-list");
    Sortable.create(list, {
        animation: 150,
        onEnd: () => {
            const order = Array.from(list.children).map((li, i) => ({
                id: li.dataset.id,
                order: i
            }));
            fetch("/reorder", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(order),
            });
        }
    });

    const modal = document.getElementById("editModal");
    const modalBody = document.getElementById("modal-body");
    const closeModal = document.getElementById("closeModal");

    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
            e.preventDefault();
            const url = btn.getAttribute("href");

            const res = await fetch(url);
            const html = await res.text();

            modalBody.innerHTML = html;
            modal.style.display = "flex";

            const form = document.getElementById("edit-task-form");
            form.addEventListener("submit", async (evt) => {
                evt.preventDefault();

                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: "POST",
                    body: formData
                });

                if (response.redirected) {
                    window.location = response.url;
                    return;
                }

                const json = await response.json();

                if (json.success) {
                    location.reload();
                }
            });

        });
    });

    closeModal.onclick = () => modal.style.display = "none";
    window.onclick = (e) => {
        if (e.target === modal) modal.style.display = "none";
    };
</script>

{% endblock %}